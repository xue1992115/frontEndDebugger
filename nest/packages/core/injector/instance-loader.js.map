{"version":3,"file":"instance-loader.js","sourceRoot":"/Users/hanxiaoxue/Documents/work/frontEndDebugger/nest/packages/core/","sources":["injector/instance-loader.ts"],"names":[],"mappings":"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","sourcesContent":["import { Logger, LoggerService } from '@nestjs/common';\nimport { Controller } from '@nestjs/common/interfaces/controllers/controller.interface';\nimport { Injectable } from '@nestjs/common/interfaces/injectable.interface';\nimport { MODULE_INIT_MESSAGE } from '../helpers/messages';\nimport { GraphInspector } from '../inspector/graph-inspector';\nimport { NestContainer } from './container';\nimport { Injector } from './injector';\nimport { InternalCoreModule } from './internal-core-module/internal-core-module';\nimport { Module } from './module';\n\nexport class InstanceLoader<TInjector extends Injector = Injector> {\n  constructor(\n    protected readonly container: NestContainer,\n    protected readonly injector: TInjector,\n    protected readonly graphInspector: GraphInspector,\n    private logger: LoggerService = new Logger(InstanceLoader.name, {\n      timestamp: true,\n    }),\n  ) {}\n\n  public setLogger(logger: Logger) {\n    this.logger = logger;\n  }\n\n  public async createInstancesOfDependencies(\n    modules: Map<string, Module> = this.container.getModules(),\n  ) {\n    this.createPrototypes(modules);\n\n    try {\n      await this.createInstances(modules);\n    } catch (err) {\n      this.graphInspector.inspectModules(modules);\n      this.graphInspector.registerPartial(err);\n      throw err;\n    }\n    this.graphInspector.inspectModules(modules);\n  }\n\n  private createPrototypes(modules: Map<string, Module>) {\n    modules.forEach(moduleRef => {\n      this.createPrototypesOfProviders(moduleRef);\n      this.createPrototypesOfInjectables(moduleRef);\n      this.createPrototypesOfControllers(moduleRef);\n    });\n  }\n\n  private async createInstances(modules: Map<string, Module>) {\n    await Promise.all(\n      [...modules.values()].map(async moduleRef => {\n        await this.createInstancesOfProviders(moduleRef);\n        await this.createInstancesOfInjectables(moduleRef);\n        await this.createInstancesOfControllers(moduleRef);\n\n        const { name } = moduleRef;\n        this.isModuleWhitelisted(name) &&\n          this.logger.log(MODULE_INIT_MESSAGE`${name}`);\n      }),\n    );\n  }\n\n  private createPrototypesOfProviders(moduleRef: Module) {\n    const { providers } = moduleRef;\n    providers.forEach(wrapper =>\n      this.injector.loadPrototype<Injectable>(wrapper, providers),\n    );\n  }\n\n  private async createInstancesOfProviders(moduleRef: Module) {\n    const { providers } = moduleRef;\n    const wrappers = [...providers.values()];\n    await Promise.all(\n      wrappers.map(async item => {\n        await this.injector.loadProvider(item, moduleRef);\n        this.graphInspector.inspectInstanceWrapper(item, moduleRef);\n      }),\n    );\n  }\n\n  private createPrototypesOfControllers(moduleRef: Module) {\n    const { controllers } = moduleRef;\n    controllers.forEach(wrapper =>\n      this.injector.loadPrototype<Controller>(wrapper, controllers),\n    );\n  }\n\n  private async createInstancesOfControllers(moduleRef: Module) {\n    const { controllers } = moduleRef;\n    const wrappers = [...controllers.values()];\n    await Promise.all(\n      wrappers.map(async item => {\n        await this.injector.loadController(item, moduleRef);\n        this.graphInspector.inspectInstanceWrapper(item, moduleRef);\n      }),\n    );\n  }\n\n  private createPrototypesOfInjectables(moduleRef: Module) {\n    const { injectables } = moduleRef;\n    injectables.forEach(wrapper =>\n      this.injector.loadPrototype(wrapper, injectables),\n    );\n  }\n\n  private async createInstancesOfInjectables(moduleRef: Module) {\n    const { injectables } = moduleRef;\n    const wrappers = [...injectables.values()];\n    await Promise.all(\n      wrappers.map(async item => {\n        await this.injector.loadInjectable(item, moduleRef);\n        this.graphInspector.inspectInstanceWrapper(item, moduleRef);\n      }),\n    );\n  }\n\n  private isModuleWhitelisted(name: string): boolean {\n    return name !== InternalCoreModule.name;\n  }\n}\n"]}