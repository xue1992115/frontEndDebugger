{"version":3,"file":"module-token-factory.js","sourceRoot":"/Users/hanxiaoxue/Documents/work/frontEndDebugger/nest/packages/core/","sources":["injector/module-token-factory.ts"],"names":[],"mappings":"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","sourcesContent":["import { DynamicModule } from '@nestjs/common';\nimport { Type } from '@nestjs/common/interfaces/type.interface';\nimport { randomStringGenerator } from '@nestjs/common/utils/random-string-generator.util';\nimport { isFunction, isSymbol } from '@nestjs/common/utils/shared.utils';\nimport { createHash } from 'crypto';\nimport stringify from 'fast-safe-stringify';\n\nconst CLASS_STR = 'class ';\nconst CLASS_STR_LEN = CLASS_STR.length;\n\nexport class ModuleTokenFactory {\n  private readonly moduleTokenCache = new Map<string, string>();\n  private readonly moduleIdsCache = new WeakMap<Type<unknown>, string>();\n\n  public create(\n    metatype: Type<unknown>,\n    dynamicModuleMetadata?: Partial<DynamicModule> | undefined,\n  ): string {\n    const moduleId = this.getModuleId(metatype);\n\n    if (!dynamicModuleMetadata) {\n      return this.getStaticModuleToken(moduleId, this.getModuleName(metatype));\n    }\n    const opaqueToken = {\n      id: moduleId,\n      module: this.getModuleName(metatype),\n      dynamic: dynamicModuleMetadata,\n    };\n    const opaqueTokenString = this.getStringifiedOpaqueToken(opaqueToken);\n\n    return this.hashString(opaqueTokenString);\n  }\n\n  public getStaticModuleToken(moduleId: string, moduleName: string): string {\n    const key = `${moduleId}_${moduleName}`;\n    if (this.moduleTokenCache.has(key)) {\n      return this.moduleTokenCache.get(key);\n    }\n\n    const hash = this.hashString(key);\n    this.moduleTokenCache.set(key, hash);\n    return hash;\n  }\n\n  public getStringifiedOpaqueToken(opaqueToken: object | undefined): string {\n    // Uses safeStringify instead of JSON.stringify to support circular dynamic modules\n    // The replacer function is also required in order to obtain real class names\n    // instead of the unified \"Function\" key\n    return opaqueToken ? stringify(opaqueToken, this.replacer) : '';\n  }\n\n  public getModuleId(metatype: Type<unknown>): string {\n    let moduleId = this.moduleIdsCache.get(metatype);\n    if (moduleId) {\n      return moduleId;\n    }\n    moduleId = randomStringGenerator();\n    this.moduleIdsCache.set(metatype, moduleId);\n    return moduleId;\n  }\n\n  public getModuleName(metatype: Type<any>): string {\n    return metatype.name;\n  }\n\n  private hashString(value: string): string {\n    return createHash('sha256').update(value).digest('hex');\n  }\n\n  private replacer(key: string, value: any) {\n    if (isFunction(value)) {\n      const funcAsString = value.toString();\n      const isClass = funcAsString.slice(0, CLASS_STR_LEN) === CLASS_STR;\n      if (isClass) {\n        return value.name;\n      }\n      return funcAsString;\n    }\n    if (isSymbol(value)) {\n      return value.toString();\n    }\n    return value;\n  }\n}\n"]}