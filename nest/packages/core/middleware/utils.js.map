{"version":3,"file":"utils.js","sourceRoot":"/Users/hanxiaoxue/Documents/work/frontEndDebugger/nest/packages/core/","sources":["middleware/utils.ts"],"names":[],"mappings":"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","sourcesContent":["import { RequestMethod } from '@nestjs/common';\nimport { HttpServer, RouteInfo, Type } from '@nestjs/common/interfaces';\nimport {\n  addLeadingSlash,\n  isFunction,\n  isString,\n} from '@nestjs/common/utils/shared.utils';\nimport { iterate } from 'iterare';\nimport * as pathToRegexp from 'path-to-regexp';\nimport { uid } from 'uid';\nimport { ExcludeRouteMetadata } from '../router/interfaces/exclude-route-metadata.interface';\nimport { isRouteExcluded } from '../router/utils';\n\nexport const mapToExcludeRoute = (\n  routes: (string | RouteInfo)[],\n): ExcludeRouteMetadata[] => {\n  return routes.map(route => {\n    if (isString(route)) {\n      return {\n        path: route,\n        requestMethod: RequestMethod.ALL,\n        pathRegex: pathToRegexp(addLeadingSlash(route)),\n      };\n    }\n    return {\n      path: route.path,\n      requestMethod: route.method,\n      pathRegex: pathToRegexp(addLeadingSlash(route.path)),\n    };\n  });\n};\n\nexport const filterMiddleware = <T extends Function | Type<any> = any>(\n  middleware: T[],\n  routes: RouteInfo[],\n  httpAdapter: HttpServer,\n) => {\n  const excludedRoutes = mapToExcludeRoute(routes);\n  return iterate([])\n    .concat(middleware)\n    .filter(isFunction)\n    .map((item: T) => mapToClass(item, excludedRoutes, httpAdapter))\n    .toArray();\n};\n\nexport const mapToClass = <T extends Function | Type<any>>(\n  middleware: T,\n  excludedRoutes: ExcludeRouteMetadata[],\n  httpAdapter: HttpServer,\n) => {\n  if (isMiddlewareClass(middleware)) {\n    if (excludedRoutes.length <= 0) {\n      return middleware;\n    }\n    const MiddlewareHost = class extends (middleware as Type<any>) {\n      use(...params: unknown[]) {\n        const [req, _, next] = params as [Record<string, any>, any, Function];\n        const isExcluded = isMiddlewareRouteExcluded(\n          req,\n          excludedRoutes,\n          httpAdapter,\n        );\n        if (isExcluded) {\n          return next();\n        }\n        return super.use(...params);\n      }\n    };\n    return assignToken(MiddlewareHost, middleware.name);\n  }\n  return assignToken(\n    class {\n      use = (...params: unknown[]) => {\n        const [req, _, next] = params as [Record<string, any>, any, Function];\n        const isExcluded = isMiddlewareRouteExcluded(\n          req,\n          excludedRoutes,\n          httpAdapter,\n        );\n        if (isExcluded) {\n          return next();\n        }\n        return (middleware as Function)(...params);\n      };\n    },\n  );\n};\n\nexport function isMiddlewareClass(middleware: any): middleware is Type<any> {\n  const middlewareStr = middleware.toString();\n  if (middlewareStr.substring(0, 5) === 'class') {\n    return true;\n  }\n  const middlewareArr = middlewareStr.split(' ');\n  return (\n    middlewareArr[0] === 'function' &&\n    /[A-Z]/.test(middlewareArr[1]?.[0]) &&\n    isFunction(middleware.prototype?.use)\n  );\n}\n\nexport function assignToken(metatype: Type<any>, token = uid(21)): Type<any> {\n  Object.defineProperty(metatype, 'name', { value: token });\n  return metatype;\n}\n\nexport function isMiddlewareRouteExcluded(\n  req: Record<string, any>,\n  excludedRoutes: ExcludeRouteMetadata[],\n  httpAdapter: HttpServer,\n): boolean {\n  if (excludedRoutes.length <= 0) {\n    return false;\n  }\n  const reqMethod = httpAdapter.getRequestMethod(req);\n  const originalUrl = httpAdapter.getRequestUrl(req);\n  const queryParamsIndex = originalUrl && originalUrl.indexOf('?');\n  const pathname =\n    queryParamsIndex >= 0\n      ? originalUrl.slice(0, queryParamsIndex)\n      : originalUrl;\n\n  return isRouteExcluded(excludedRoutes, pathname, RequestMethod[reqMethod]);\n}\n"]}