{"version":3,"file":"nest-application-context.js","sourceRoot":"/Users/hanxiaoxue/Documents/work/frontEndDebugger/nest/packages/core/","sources":["nest-application-context.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  INestApplicationContext,\n  Logger,\n  LoggerService,\n  LogLevel,\n  ShutdownSignal,\n} from '@nestjs/common';\nimport {\n  Abstract,\n  DynamicModule,\n  GetOrResolveOptions,\n  Type,\n} from '@nestjs/common/interfaces';\nimport { NestApplicationContextOptions } from '@nestjs/common/interfaces/nest-application-context-options.interface';\nimport { isEmpty } from '@nestjs/common/utils/shared.utils';\nimport { iterate } from 'iterare';\nimport { MESSAGES } from './constants';\nimport { UnknownModuleException } from './errors/exceptions';\nimport { createContextId } from './helpers/context-id-factory';\nimport {\n  callAppShutdownHook,\n  callBeforeAppShutdownHook,\n  callModuleBootstrapHook,\n  callModuleDestroyHook,\n  callModuleInitHook,\n} from './hooks';\nimport { AbstractInstanceResolver } from './injector/abstract-instance-resolver';\nimport { ModuleCompiler } from './injector/compiler';\nimport { NestContainer } from './injector/container';\nimport { Injector } from './injector/injector';\nimport { InstanceLinksHost } from './injector/instance-links-host';\nimport { ContextId } from './injector/instance-wrapper';\nimport { Module } from './injector/module';\n\n/**\n * @publicApi\n */\nexport class NestApplicationContext<\n    TOptions extends NestApplicationContextOptions = NestApplicationContextOptions,\n  >\n  extends AbstractInstanceResolver\n  implements INestApplicationContext\n{\n  protected isInitialized = false;\n  protected injector: Injector;\n  protected readonly logger = new Logger(NestApplicationContext.name, {\n    timestamp: true,\n  });\n\n  private shouldFlushLogsOnOverride = false;\n  private readonly activeShutdownSignals = new Array<string>();\n  private readonly moduleCompiler = new ModuleCompiler();\n  private shutdownCleanupRef?: (...args: unknown[]) => unknown;\n  private _instanceLinksHost: InstanceLinksHost;\n  private _moduleRefsForHooksByDistance?: Array<Module>;\n\n  protected get instanceLinksHost() {\n    if (!this._instanceLinksHost) {\n      this._instanceLinksHost = new InstanceLinksHost(this.container);\n    }\n    return this._instanceLinksHost;\n  }\n\n  constructor(\n    protected readonly container: NestContainer,\n    protected readonly appOptions: TOptions = {} as TOptions,\n    private contextModule: Module = null,\n    private readonly scope = new Array<Type<any>>(),\n  ) {\n    super();\n    this.injector = new Injector();\n\n    if (this.appOptions.preview) {\n      this.printInPreviewModeWarning();\n    }\n  }\n\n  public selectContextModule() {\n    const modules = this.container.getModules().values();\n    this.contextModule = modules.next().value;\n  }\n\n  /**\n   * Allows navigating through the modules tree, for example, to pull out a specific instance from the selected module.\n   * @returns {INestApplicationContext}\n   */\n  public select<T>(\n    moduleType: Type<T> | DynamicModule,\n  ): INestApplicationContext {\n    const modulesContainer = this.container.getModules();\n    const contextModuleCtor = this.contextModule.metatype;\n    const scope = this.scope.concat(contextModuleCtor);\n\n    const moduleTokenFactory = this.container.getModuleTokenFactory();\n    const { type, dynamicMetadata } =\n      this.moduleCompiler.extractMetadata(moduleType);\n    const token = moduleTokenFactory.create(type, dynamicMetadata);\n\n    const selectedModule = modulesContainer.get(token);\n    if (!selectedModule) {\n      throw new UnknownModuleException();\n    }\n    return new NestApplicationContext(\n      this.container,\n      this.appOptions,\n      selectedModule,\n      scope,\n    );\n  }\n\n  /**\n   * Retrieves an instance of either injectable or controller, otherwise, throws exception.\n   * @returns {TResult}\n   */\n  public get<TInput = any, TResult = TInput>(\n    typeOrToken: Type<TInput> | Function | string | symbol,\n  ): TResult;\n  /**\n   * Retrieves an instance of either injectable or controller, otherwise, throws exception.\n   * @returns {TResult}\n   */\n  public get<TInput = any, TResult = TInput>(\n    typeOrToken: Type<TInput> | Function | string | symbol,\n    options: {\n      strict?: boolean;\n      each?: undefined | false;\n    },\n  ): TResult;\n  /**\n   * Retrieves a list of instances of either injectables or controllers, otherwise, throws exception.\n   * @returns {Array<TResult>}\n   */\n  public get<TInput = any, TResult = TInput>(\n    typeOrToken: Type<TInput> | Function | string | symbol,\n    options: {\n      strict?: boolean;\n      each: true;\n    },\n  ): Array<TResult>;\n  /**\n   * Retrieves an instance (or a list of instances) of either injectable or controller, otherwise, throws exception.\n   * @returns {TResult | Array<TResult>}\n   */\n  public get<TInput = any, TResult = TInput>(\n    typeOrToken: Type<TInput> | Abstract<TInput> | string | symbol,\n    options: GetOrResolveOptions = { strict: false },\n  ): TResult | Array<TResult> {\n    return !(options && options.strict)\n      ? this.find<TInput, TResult>(typeOrToken, options)\n      : this.find<TInput, TResult>(typeOrToken, {\n          moduleId: this.contextModule?.id,\n          each: options.each,\n        });\n  }\n\n  /**\n   * Resolves transient or request-scoped instance of either injectable or controller, otherwise, throws exception.\n   * @returns {Array<TResult>}\n   */\n  public resolve<TInput = any, TResult = TInput>(\n    typeOrToken: Type<TInput> | Function | string | symbol,\n  ): Promise<TResult>;\n  /**\n   * Resolves transient or request-scoped instance of either injectable or controller, otherwise, throws exception.\n   * @returns {Array<TResult>}\n   */\n  public resolve<TInput = any, TResult = TInput>(\n    typeOrToken: Type<TInput> | Function | string | symbol,\n    contextId?: {\n      id: number;\n    },\n  ): Promise<TResult>;\n  /**\n   * Resolves transient or request-scoped instance of either injectable or controller, otherwise, throws exception.\n   * @returns {Array<TResult>}\n   */\n  public resolve<TInput = any, TResult = TInput>(\n    typeOrToken: Type<TInput> | Function | string | symbol,\n    contextId?: {\n      id: number;\n    },\n    options?: {\n      strict?: boolean;\n      each?: undefined | false;\n    },\n  ): Promise<TResult>;\n  /**\n   * Resolves transient or request-scoped instances of either injectables or controllers, otherwise, throws exception.\n   * @returns {Array<TResult>}\n   */\n  public resolve<TInput = any, TResult = TInput>(\n    typeOrToken: Type<TInput> | Function | string | symbol,\n    contextId?: {\n      id: number;\n    },\n    options?: {\n      strict?: boolean;\n      each: true;\n    },\n  ): Promise<Array<TResult>>;\n  /**\n   * Resolves transient or request-scoped instance (or a list of instances) of either injectable or controller, otherwise, throws exception.\n   * @returns {Promise<TResult | Array<TResult>>}\n   */\n  public resolve<TInput = any, TResult = TInput>(\n    typeOrToken: Type<TInput> | Abstract<TInput> | string | symbol,\n    contextId = createContextId(),\n    options: GetOrResolveOptions = { strict: false },\n  ): Promise<TResult | Array<TResult>> {\n    return this.resolvePerContext<TInput, TResult>(\n      typeOrToken,\n      this.contextModule,\n      contextId,\n      options,\n    );\n  }\n\n  /**\n   * Registers the request/context object for a given context ID (DI container sub-tree).\n   * @returns {void}\n   */\n  public registerRequestByContextId<T = any>(request: T, contextId: ContextId) {\n    this.container.registerRequestProvider(request, contextId);\n  }\n\n  /**\n   * Initializes the Nest application.\n   * Calls the Nest lifecycle events.\n   *\n   * @returns {Promise<this>} The NestApplicationContext instance as Promise\n   */\n  public async init(): Promise<this> {\n    if (this.isInitialized) {\n      return this;\n    }\n    await this.callInitHook();\n    await this.callBootstrapHook();\n\n    this.isInitialized = true;\n    return this;\n  }\n\n  /**\n   * Terminates the application\n   * @returns {Promise<void>}\n   */\n  public async close(signal?: string): Promise<void> {\n    await this.callDestroyHook();\n    await this.callBeforeShutdownHook(signal);\n    await this.dispose();\n    await this.callShutdownHook(signal);\n    this.unsubscribeFromProcessSignals();\n  }\n\n  /**\n   * Sets custom logger service.\n   * Flushes buffered logs if auto flush is on.\n   * @returns {void}\n   */\n  public useLogger(logger: LoggerService | LogLevel[] | false) {\n    Logger.overrideLogger(logger);\n\n    if (this.shouldFlushLogsOnOverride) {\n      this.flushLogs();\n    }\n  }\n\n  /**\n   * Prints buffered logs and detaches buffer.\n   * @returns {void}\n   */\n  public flushLogs() {\n    Logger.flush();\n  }\n\n  /**\n   * Define that it must flush logs right after defining a custom logger.\n   */\n  public flushLogsOnOverride() {\n    this.shouldFlushLogsOnOverride = true;\n  }\n\n  /**\n   * Enables the usage of shutdown hooks. Will call the\n   * `onApplicationShutdown` function of a provider if the\n   * process receives a shutdown signal.\n   *\n   * @param {ShutdownSignal[]} [signals=[]] The system signals it should listen to\n   *\n   * @returns {this} The Nest application context instance\n   */\n  public enableShutdownHooks(signals: (ShutdownSignal | string)[] = []): this {\n    if (isEmpty(signals)) {\n      signals = Object.keys(ShutdownSignal).map(\n        (key: string) => ShutdownSignal[key],\n      );\n    } else {\n      // given signals array should be unique because\n      // process shouldn't listen to the same signal more than once.\n      signals = Array.from(new Set(signals));\n    }\n\n    signals = iterate(signals)\n      .map((signal: string) => signal.toString().toUpperCase().trim())\n      // filter out the signals which is already listening to\n      .filter(signal => !this.activeShutdownSignals.includes(signal))\n      .toArray();\n\n    this.listenToShutdownSignals(signals);\n    return this;\n  }\n\n  protected async dispose(): Promise<void> {\n    // Nest application context has no server\n    // to dispose, therefore just call a noop\n    return Promise.resolve();\n  }\n\n  /**\n   * Listens to shutdown signals by listening to\n   * process events\n   *\n   * @param {string[]} signals The system signals it should listen to\n   */\n  protected listenToShutdownSignals(signals: string[]) {\n    let receivedSignal = false;\n    const cleanup = async (signal: string) => {\n      try {\n        if (receivedSignal) {\n          // If we receive another signal while we're waiting\n          // for the server to stop, just ignore it.\n          return;\n        }\n        receivedSignal = true;\n        await this.callDestroyHook();\n        await this.callBeforeShutdownHook(signal);\n        await this.dispose();\n        await this.callShutdownHook(signal);\n        signals.forEach(sig => process.removeListener(sig, cleanup));\n        process.kill(process.pid, signal);\n      } catch (err) {\n        Logger.error(\n          MESSAGES.ERROR_DURING_SHUTDOWN,\n          (err as Error)?.stack,\n          NestApplicationContext.name,\n        );\n        process.exit(1);\n      }\n    };\n    this.shutdownCleanupRef = cleanup as (...args: unknown[]) => unknown;\n\n    signals.forEach((signal: string) => {\n      this.activeShutdownSignals.push(signal);\n      process.on(signal as any, cleanup);\n    });\n  }\n\n  /**\n   * Unsubscribes from shutdown signals (process events)\n   */\n  protected unsubscribeFromProcessSignals() {\n    if (!this.shutdownCleanupRef) {\n      return;\n    }\n    this.activeShutdownSignals.forEach(signal => {\n      process.removeListener(signal, this.shutdownCleanupRef);\n    });\n  }\n\n  /**\n   * Calls the `onModuleInit` function on the registered\n   * modules and its children.\n   */\n  protected async callInitHook(): Promise<void> {\n    const modulesSortedByDistance = this.getModulesToTriggerHooksOn();\n    for (const module of modulesSortedByDistance) {\n      await callModuleInitHook(module);\n    }\n  }\n\n  /**\n   * Calls the `onModuleDestroy` function on the registered\n   * modules and its children.\n   */\n  protected async callDestroyHook(): Promise<void> {\n    const modulesSortedByDistance = this.getModulesToTriggerHooksOn();\n    for (const module of modulesSortedByDistance) {\n      await callModuleDestroyHook(module);\n    }\n  }\n\n  /**\n   * Calls the `onApplicationBootstrap` function on the registered\n   * modules and its children.\n   */\n  protected async callBootstrapHook(): Promise<void> {\n    const modulesSortedByDistance = this.getModulesToTriggerHooksOn();\n    for (const module of modulesSortedByDistance) {\n      await callModuleBootstrapHook(module);\n    }\n  }\n\n  /**\n   * Calls the `onApplicationShutdown` function on the registered\n   * modules and children.\n   */\n  protected async callShutdownHook(signal?: string): Promise<void> {\n    const modulesSortedByDistance = this.getModulesToTriggerHooksOn();\n    for (const module of modulesSortedByDistance) {\n      await callAppShutdownHook(module, signal);\n    }\n  }\n\n  /**\n   * Calls the `beforeApplicationShutdown` function on the registered\n   * modules and children.\n   */\n  protected async callBeforeShutdownHook(signal?: string): Promise<void> {\n    const modulesSortedByDistance = this.getModulesToTriggerHooksOn();\n    for (const module of modulesSortedByDistance) {\n      await callBeforeAppShutdownHook(module, signal);\n    }\n  }\n\n  protected assertNotInPreviewMode(methodName: string) {\n    if (this.appOptions.preview) {\n      const error = `Calling the \"${methodName}\" in the preview mode is not supported.`;\n      this.logger.error(error);\n      throw new Error(error);\n    }\n  }\n\n  private getModulesToTriggerHooksOn(): Module[] {\n    if (this._moduleRefsForHooksByDistance) {\n      return this._moduleRefsForHooksByDistance;\n    }\n    const modulesContainer = this.container.getModules();\n    const compareFn = (a: Module, b: Module) => b.distance - a.distance;\n    const modulesSortedByDistance = Array.from(modulesContainer.values()).sort(\n      compareFn,\n    );\n\n    this._moduleRefsForHooksByDistance = this.appOptions?.preview\n      ? modulesSortedByDistance.filter(moduleRef => moduleRef.initOnPreview)\n      : modulesSortedByDistance;\n    return this._moduleRefsForHooksByDistance;\n  }\n\n  private printInPreviewModeWarning() {\n    this.logger.warn('------------------------------------------------');\n    this.logger.warn('Application is running in the PREVIEW mode!');\n    this.logger.warn('Providers/controllers will not be instantiated.');\n    this.logger.warn('------------------------------------------------');\n  }\n}\n"]}