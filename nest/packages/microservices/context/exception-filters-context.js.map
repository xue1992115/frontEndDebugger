{"version":3,"file":"exception-filters-context.js","sourceRoot":"","sources":["exception-filters-context.ts"],"names":[],"mappings":";;;AAAA,wDAAsE;AAEtE,oEAA4D;AAE5D,yGAAmG;AACnG,+DAAiE;AAGjE,qCAAkC;AAElC,iFAA4E;AAE5E;;GAEG;AACH,MAAa,uBAAwB,SAAQ,0DAA0B;IACrE,YACE,SAAwB,EACP,MAAyB;QAE1C,KAAK,CAAC,SAAS,CAAC,CAAC;QAFA,WAAM,GAAN,MAAM,CAAmB;IAG5C,CAAC;IAEM,MAAM,CACX,QAAoB,EACpB,QAA+C,EAC/C,MAAc,EACd,SAAS,GAAG,0BAAc,EAC1B,UAAmB;QAEnB,IAAI,CAAC,aAAa,GAAG,MAAM,CAAC;QAE5B,MAAM,gBAAgB,GAAG,IAAI,6CAAoB,EAAE,CAAC;QACpD,MAAM,OAAO,GAAG,IAAI,CAAC,aAAa,CAChC,QAAQ,EACR,QAAQ,EACR,sCAA0B,EAC1B,SAAS,EACT,UAAU,CACX,CAAC;QACF,IAAI,IAAA,sBAAO,EAAC,OAAO,CAAC,EAAE;YACpB,OAAO,gBAAgB,CAAC;SACzB;QACD,gBAAgB,CAAC,gBAAgB,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC,CAAC;QACrD,OAAO,gBAAgB,CAAC;IAC1B,CAAC;IAEM,iBAAiB,CACtB,SAAS,GAAG,0BAAc,EAC1B,UAAmB;QAEnB,MAAM,aAAa,GAAG,IAAI,CAAC,MAAM,CAAC,gBAAgB,EAAO,CAAC;QAC1D,IAAI,SAAS,KAAK,0BAAc,IAAI,CAAC,UAAU,EAAE;YAC/C,OAAO,aAAa,CAAC;SACtB;QACD,MAAM,oBAAoB,GACxB,IAAI,CAAC,MAAM,CAAC,uBAAuB,EAAuB,CAAC;QAC7D,MAAM,aAAa,GAAG,IAAA,iBAAO,EAAC,oBAAoB,CAAC;aAChD,GAAG,CAAC,OAAO,CAAC,EAAE,CACb,OAAO,CAAC,sBAAsB,CAC5B,IAAI,CAAC,YAAY,CAAC,SAAS,EAAE,OAAO,CAAC,EACrC,UAAU,CACX,CACF;aACA,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC;aACtB,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,IAAI,CAAC,QAAQ,CAAC;aAC1B,OAAO,EAAE,CAAC;QAEb,OAAO,aAAa,CAAC,MAAM,CAAC,aAAa,CAAM,CAAC;IAClD,CAAC;CACF;AAvDD,0DAuDC","sourcesContent":["import { EXCEPTION_FILTERS_METADATA } from '@nestjs/common/constants';\nimport { Controller } from '@nestjs/common/interfaces/controllers/controller.interface';\nimport { isEmpty } from '@nestjs/common/utils/shared.utils';\nimport { ApplicationConfig } from '@nestjs/core/application-config';\nimport { BaseExceptionFilterContext } from '@nestjs/core/exceptions/base-exception-filter-context';\nimport { STATIC_CONTEXT } from '@nestjs/core/injector/constants';\nimport { NestContainer } from '@nestjs/core/injector/container';\nimport { InstanceWrapper } from '@nestjs/core/injector/instance-wrapper';\nimport { iterate } from 'iterare';\nimport { Observable } from 'rxjs';\nimport { RpcExceptionsHandler } from '../exceptions/rpc-exceptions-handler';\n\n/**\n * @publicApi\n */\nexport class ExceptionFiltersContext extends BaseExceptionFilterContext {\n  constructor(\n    container: NestContainer,\n    private readonly config: ApplicationConfig,\n  ) {\n    super(container);\n  }\n\n  public create(\n    instance: Controller,\n    callback: <T = any>(data: T) => Observable<any>,\n    module: string,\n    contextId = STATIC_CONTEXT,\n    inquirerId?: string,\n  ): RpcExceptionsHandler {\n    this.moduleContext = module;\n\n    const exceptionHandler = new RpcExceptionsHandler();\n    const filters = this.createContext(\n      instance,\n      callback,\n      EXCEPTION_FILTERS_METADATA,\n      contextId,\n      inquirerId,\n    );\n    if (isEmpty(filters)) {\n      return exceptionHandler;\n    }\n    exceptionHandler.setCustomFilters(filters.reverse());\n    return exceptionHandler;\n  }\n\n  public getGlobalMetadata<T extends any[]>(\n    contextId = STATIC_CONTEXT,\n    inquirerId?: string,\n  ): T {\n    const globalFilters = this.config.getGlobalFilters() as T;\n    if (contextId === STATIC_CONTEXT && !inquirerId) {\n      return globalFilters;\n    }\n    const scopedFilterWrappers =\n      this.config.getGlobalRequestFilters() as InstanceWrapper[];\n    const scopedFilters = iterate(scopedFilterWrappers)\n      .map(wrapper =>\n        wrapper.getInstanceByContextId(\n          this.getContextId(contextId, wrapper),\n          inquirerId,\n        ),\n      )\n      .filter(host => !!host)\n      .map(host => host.instance)\n      .toArray();\n\n    return globalFilters.concat(scopedFilters) as T;\n  }\n}\n"]}