{"version":3,"file":"nest-microservice.js","sourceRoot":"","sources":["nest-microservice.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  CanActivate,\n  ExceptionFilter,\n  INestMicroservice,\n  NestInterceptor,\n  PipeTransform,\n  WebSocketAdapter,\n} from '@nestjs/common';\nimport { NestMicroserviceOptions } from '@nestjs/common/interfaces/microservices/nest-microservice-options.interface';\nimport { Logger } from '@nestjs/common/services/logger.service';\nimport { ApplicationConfig } from '@nestjs/core/application-config';\nimport { MESSAGES } from '@nestjs/core/constants';\nimport { optionalRequire } from '@nestjs/core/helpers/optional-require';\nimport { NestContainer } from '@nestjs/core/injector/container';\nimport { Injector } from '@nestjs/core/injector/injector';\nimport { GraphInspector } from '@nestjs/core/inspector/graph-inspector';\nimport { NestApplicationContext } from '@nestjs/core/nest-application-context';\nimport { Transport } from './enums/transport.enum';\nimport { CustomTransportStrategy } from './interfaces/custom-transport-strategy.interface';\nimport { MicroserviceOptions } from './interfaces/microservice-configuration.interface';\nimport { MicroservicesModule } from './microservices-module';\nimport { Server } from './server/server';\nimport { ServerFactory } from './server/server-factory';\n\nconst { SocketModule } = optionalRequire(\n  '@nestjs/websockets/socket-module',\n  () => require('@nestjs/websockets/socket-module'),\n);\n\nexport class NestMicroservice\n  extends NestApplicationContext<NestMicroserviceOptions>\n  implements INestMicroservice\n{\n  protected readonly logger = new Logger(NestMicroservice.name, {\n    timestamp: true,\n  });\n  private readonly microservicesModule = new MicroservicesModule();\n  private readonly socketModule = SocketModule ? new SocketModule() : null;\n  private microserviceConfig: NestMicroserviceOptions & MicroserviceOptions;\n  private server: Server & CustomTransportStrategy;\n  private isTerminated = false;\n  private isInitHookCalled = false;\n\n  constructor(\n    container: NestContainer,\n    config: NestMicroserviceOptions & MicroserviceOptions = {},\n    private readonly graphInspector: GraphInspector,\n    private readonly applicationConfig: ApplicationConfig,\n  ) {\n    super(container, config);\n\n    this.injector = new Injector({ preview: config.preview });\n    this.microservicesModule.register(\n      container,\n      this.graphInspector,\n      this.applicationConfig,\n      this.appOptions,\n    );\n    this.createServer(config);\n    this.selectContextModule();\n  }\n\n  public createServer(config: NestMicroserviceOptions & MicroserviceOptions) {\n    try {\n      this.microserviceConfig = {\n        transport: Transport.TCP,\n        ...config,\n      } as any;\n      const { strategy } = config as any;\n      this.server = strategy\n        ? strategy\n        : ServerFactory.create(this.microserviceConfig);\n    } catch (e) {\n      this.logger.error(e);\n      throw e;\n    }\n  }\n\n  public async registerModules(): Promise<any> {\n    this.socketModule &&\n      this.socketModule.register(\n        this.container,\n        this.applicationConfig,\n        this.graphInspector,\n        this.appOptions,\n      );\n\n    if (!this.appOptions.preview) {\n      this.microservicesModule.setupClients(this.container);\n      this.registerListeners();\n    }\n\n    this.setIsInitialized(true);\n\n    if (!this.isInitHookCalled) {\n      await this.callInitHook();\n      await this.callBootstrapHook();\n    }\n  }\n\n  public registerListeners() {\n    this.microservicesModule.setupListeners(this.container, this.server);\n  }\n\n  public useWebSocketAdapter(adapter: WebSocketAdapter): this {\n    this.applicationConfig.setIoAdapter(adapter);\n    return this;\n  }\n\n  public useGlobalFilters(...filters: ExceptionFilter[]): this {\n    this.applicationConfig.useGlobalFilters(...filters);\n    filters.forEach(item =>\n      this.graphInspector.insertOrphanedEnhancer({\n        subtype: 'filter',\n        ref: item,\n      }),\n    );\n    return this;\n  }\n\n  public useGlobalPipes(...pipes: PipeTransform<any>[]): this {\n    this.applicationConfig.useGlobalPipes(...pipes);\n    pipes.forEach(item =>\n      this.graphInspector.insertOrphanedEnhancer({\n        subtype: 'pipe',\n        ref: item,\n      }),\n    );\n    return this;\n  }\n\n  public useGlobalInterceptors(...interceptors: NestInterceptor[]): this {\n    this.applicationConfig.useGlobalInterceptors(...interceptors);\n    interceptors.forEach(item =>\n      this.graphInspector.insertOrphanedEnhancer({\n        subtype: 'interceptor',\n        ref: item,\n      }),\n    );\n    return this;\n  }\n\n  public useGlobalGuards(...guards: CanActivate[]): this {\n    this.applicationConfig.useGlobalGuards(...guards);\n    guards.forEach(item =>\n      this.graphInspector.insertOrphanedEnhancer({\n        subtype: 'guard',\n        ref: item,\n      }),\n    );\n    return this;\n  }\n\n  public async init(): Promise<this> {\n    if (this.isInitialized) {\n      return this;\n    }\n    await super.init();\n    await this.registerModules();\n    return this;\n  }\n\n  public async listen() {\n    this.assertNotInPreviewMode('listen');\n    !this.isInitialized && (await this.registerModules());\n\n    return new Promise<any>((resolve, reject) => {\n      this.server.listen((err, info) => {\n        if (this.microserviceConfig?.autoFlushLogs ?? true) {\n          this.flushLogs();\n        }\n        if (err) {\n          return reject(err);\n        }\n        this.logger.log(MESSAGES.MICROSERVICE_READY);\n        resolve(info);\n      });\n    });\n  }\n\n  public async close(): Promise<any> {\n    await this.server.close();\n    if (this.isTerminated) {\n      return;\n    }\n    this.setIsTerminated(true);\n    await this.closeApplication();\n  }\n\n  public setIsInitialized(isInitialized: boolean) {\n    this.isInitialized = isInitialized;\n  }\n\n  public setIsTerminated(isTerminated: boolean) {\n    this.isTerminated = isTerminated;\n  }\n\n  public setIsInitHookCalled(isInitHookCalled: boolean) {\n    this.isInitHookCalled = isInitHookCalled;\n  }\n\n  protected async closeApplication(): Promise<any> {\n    this.socketModule && (await this.socketModule.close());\n    this.microservicesModule && (await this.microservicesModule.close());\n\n    await super.close();\n    this.setIsTerminated(true);\n  }\n\n  protected async dispose(): Promise<void> {\n    if (this.isTerminated) {\n      return;\n    }\n    await this.server.close();\n    this.socketModule && (await this.socketModule.close());\n    this.microservicesModule && (await this.microservicesModule.close());\n  }\n}\n"]}