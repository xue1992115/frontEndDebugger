{"version":3,"file":"listener-metadata-explorer.js","sourceRoot":"","sources":["listener-metadata-explorer.ts"],"names":[],"mappings":";;;AACA,oEAA4E;AAE5E,2CAOqB;AAErB,uEAA8D;AAsB9D,MAAa,wBAAwB;IACnC,YAA6B,eAAgC;QAAhC,oBAAe,GAAf,eAAe,CAAiB;IAAG,CAAC;IAE1D,OAAO,CAAC,QAAoB;QACjC,MAAM,iBAAiB,GAAG,MAAM,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC;QAC1D,OAAO,IAAI,CAAC,eAAe;aACxB,iBAAiB,CAAC,iBAAiB,CAAC;aACpC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,IAAI,CAAC,qBAAqB,CAAC,iBAAiB,EAAE,MAAM,CAAC,CAAC;aACpE,MAAM,CAAC,QAAQ,CAAC,EAAE,CAAC,QAAQ,CAAC,CAAC;IAClC,CAAC;IAEM,qBAAqB,CAC1B,iBAAyB,EACzB,SAAiB;QAEjB,MAAM,cAAc,GAAG,iBAAiB,CAAC,SAAS,CAAC,CAAC;QACpD,MAAM,WAAW,GAAG,OAAO,CAAC,WAAW,CACrC,oCAAwB,EACxB,cAAc,CACf,CAAC;QACF,IAAI,IAAA,0BAAW,EAAC,WAAW,CAAC,EAAE;YAC5B,OAAO;SACR;QACD,MAAM,QAAQ,GAAG,OAAO,CAAC,WAAW,CAAC,4BAAgB,EAAE,cAAc,CAAC,CAAC;QACvE,MAAM,SAAS,GAAG,OAAO,CAAC,WAAW,CAAC,8BAAkB,EAAE,cAAc,CAAC,CAAC;QAC1E,MAAM,MAAM,GAAG,OAAO,CAAC,WAAW,CAAC,mCAAuB,EAAE,cAAc,CAAC,CAAC;QAC5E,OAAO;YACL,SAAS;YACT,cAAc;YACd,QAAQ;YACR,SAAS;YACT,MAAM;YACN,cAAc,EAAE,WAAW,KAAK,qCAAc,CAAC,KAAK;SACrD,CAAC;IACJ,CAAC;IAEM,CAAC,kBAAkB,CACxB,QAAoB;QAEpB,KAAK,MAAM,WAAW,IAAI,QAAQ,EAAE;YAClC,IAAI,IAAA,yBAAU,EAAC,WAAW,CAAC,EAAE;gBAC3B,SAAS;aACV;YACD,MAAM,QAAQ,GAAG,MAAM,CAAC,WAAW,CAAC,CAAC;YACrC,MAAM,QAAQ,GAAG,OAAO,CAAC,WAAW,CAAC,2BAAe,EAAE,QAAQ,EAAE,QAAQ,CAAC,CAAC;YAC1E,IAAI,IAAA,0BAAW,EAAC,QAAQ,CAAC,EAAE;gBACzB,SAAS;aACV;YACD,MAAM,QAAQ,GAAG,OAAO,CAAC,WAAW,CAClC,yCAA6B,EAC7B,QAAQ,EACR,QAAQ,CACT,CAAC;YACF,MAAM,EAAE,QAAQ,EAAE,QAAQ,EAAE,CAAC;SAC9B;IACH,CAAC;CACF;AAxDD,4DAwDC","sourcesContent":["import { Controller } from '@nestjs/common/interfaces/controllers/controller.interface';\nimport { isFunction, isUndefined } from '@nestjs/common/utils/shared.utils';\nimport { MetadataScanner } from '@nestjs/core/metadata-scanner';\nimport {\n  CLIENT_CONFIGURATION_METADATA,\n  CLIENT_METADATA,\n  PATTERN_EXTRAS_METADATA,\n  PATTERN_HANDLER_METADATA,\n  PATTERN_METADATA,\n  TRANSPORT_METADATA,\n} from './constants';\nimport { Transport } from './enums';\nimport { PatternHandler } from './enums/pattern-handler.enum';\nimport { ClientOptions, PatternMetadata } from './interfaces';\n\nexport interface ClientProperties {\n  property: string;\n  metadata: ClientOptions;\n}\n\nexport interface EventOrMessageListenerDefinition {\n  patterns: PatternMetadata[];\n  methodKey: string;\n  isEventHandler: boolean;\n  targetCallback: (...args: any[]) => any;\n  transport?: Transport;\n  extras?: Record<string, any>;\n}\n\nexport interface MessageRequestProperties {\n  requestPattern: PatternMetadata;\n  replyPattern: PatternMetadata;\n}\n\nexport class ListenerMetadataExplorer {\n  constructor(private readonly metadataScanner: MetadataScanner) {}\n\n  public explore(instance: Controller): EventOrMessageListenerDefinition[] {\n    const instancePrototype = Object.getPrototypeOf(instance);\n    return this.metadataScanner\n      .getAllMethodNames(instancePrototype)\n      .map(method => this.exploreMethodMetadata(instancePrototype, method))\n      .filter(metadata => metadata);\n  }\n\n  public exploreMethodMetadata(\n    instancePrototype: object,\n    methodKey: string,\n  ): EventOrMessageListenerDefinition {\n    const targetCallback = instancePrototype[methodKey];\n    const handlerType = Reflect.getMetadata(\n      PATTERN_HANDLER_METADATA,\n      targetCallback,\n    );\n    if (isUndefined(handlerType)) {\n      return;\n    }\n    const patterns = Reflect.getMetadata(PATTERN_METADATA, targetCallback);\n    const transport = Reflect.getMetadata(TRANSPORT_METADATA, targetCallback);\n    const extras = Reflect.getMetadata(PATTERN_EXTRAS_METADATA, targetCallback);\n    return {\n      methodKey,\n      targetCallback,\n      patterns,\n      transport,\n      extras,\n      isEventHandler: handlerType === PatternHandler.EVENT,\n    };\n  }\n\n  public *scanForClientHooks(\n    instance: Controller,\n  ): IterableIterator<ClientProperties> {\n    for (const propertyKey in instance) {\n      if (isFunction(propertyKey)) {\n        continue;\n      }\n      const property = String(propertyKey);\n      const isClient = Reflect.getMetadata(CLIENT_METADATA, instance, property);\n      if (isUndefined(isClient)) {\n        continue;\n      }\n      const metadata = Reflect.getMetadata(\n        CLIENT_CONFIGURATION_METADATA,\n        instance,\n        property,\n      );\n      yield { property, metadata };\n    }\n  }\n}\n"]}