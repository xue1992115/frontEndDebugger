{"version":3,"file":"client-kafka.js","sourceRoot":"","sources":["client-kafka.ts"],"names":[],"mappings":"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","sourcesContent":["import { Logger } from '@nestjs/common/services/logger.service';\nimport { loadPackage } from '@nestjs/common/utils/load-package.util';\nimport { isUndefined } from '@nestjs/common/utils/shared.utils';\nimport {\n  KAFKA_DEFAULT_BROKER,\n  KAFKA_DEFAULT_CLIENT,\n  KAFKA_DEFAULT_GROUP,\n} from '../constants';\nimport { KafkaResponseDeserializer } from '../deserializers/kafka-response.deserializer';\nimport { KafkaHeaders } from '../enums';\nimport { InvalidKafkaClientTopicException } from '../errors/invalid-kafka-client-topic.exception';\nimport {\n  BrokersFunction,\n  Consumer,\n  ConsumerConfig,\n  ConsumerGroupJoinEvent,\n  EachMessagePayload,\n  Kafka,\n  KafkaConfig,\n  KafkaMessage,\n  Producer,\n  TopicPartitionOffsetAndMetadata,\n} from '../external/kafka.interface';\nimport {\n  KafkaLogger,\n  KafkaParser,\n  KafkaReplyPartitionAssigner,\n} from '../helpers';\nimport {\n  KafkaOptions,\n  OutgoingEvent,\n  ReadPacket,\n  WritePacket,\n} from '../interfaces';\nimport {\n  KafkaRequest,\n  KafkaRequestSerializer,\n} from '../serializers/kafka-request.serializer';\nimport { ClientProxy } from './client-proxy';\n\nlet kafkaPackage: any = {};\n\n/**\n * @publicApi\n */\nexport class ClientKafka extends ClientProxy {\n  protected logger = new Logger(ClientKafka.name);\n  protected client: Kafka | null = null;\n  protected consumer: Consumer | null = null;\n  protected producer: Producer | null = null;\n  protected parser: KafkaParser | null = null;\n  protected initialized: Promise<void> | null = null;\n  protected responsePatterns: string[] = [];\n  protected consumerAssignments: { [key: string]: number } = {};\n  protected brokers: string[] | BrokersFunction;\n  protected clientId: string;\n  protected groupId: string;\n  protected producerOnlyMode: boolean;\n\n  constructor(protected readonly options: KafkaOptions['options']) {\n    super();\n\n    const clientOptions =\n      this.getOptionsProp(this.options, 'client') || ({} as KafkaConfig);\n    const consumerOptions =\n      this.getOptionsProp(this.options, 'consumer') || ({} as ConsumerConfig);\n    const postfixId =\n      this.getOptionsProp(this.options, 'postfixId') ?? '-client';\n    this.producerOnlyMode =\n      this.getOptionsProp(this.options, 'producerOnlyMode') || false;\n\n    this.brokers = clientOptions.brokers || [KAFKA_DEFAULT_BROKER];\n\n    // Append a unique id to the clientId and groupId\n    // so they don't collide with a microservices client\n    this.clientId =\n      (clientOptions.clientId || KAFKA_DEFAULT_CLIENT) + postfixId;\n    this.groupId = (consumerOptions.groupId || KAFKA_DEFAULT_GROUP) + postfixId;\n\n    kafkaPackage = loadPackage('kafkajs', ClientKafka.name, () =>\n      require('kafkajs'),\n    );\n\n    this.parser = new KafkaParser((options && options.parser) || undefined);\n\n    this.initializeSerializer(options);\n    this.initializeDeserializer(options);\n  }\n\n  public subscribeToResponseOf(pattern: any): void {\n    const request = this.normalizePattern(pattern);\n    this.responsePatterns.push(this.getResponsePatternName(request));\n  }\n\n  public async close(): Promise<void> {\n    this.producer && (await this.producer.disconnect());\n    this.consumer && (await this.consumer.disconnect());\n    this.producer = null;\n    this.consumer = null;\n    this.initialized = null;\n    this.client = null;\n  }\n\n  public async connect(): Promise<Producer> {\n    if (this.initialized) {\n      return this.initialized.then(() => this.producer);\n    }\n    this.initialized = new Promise(async (resolve, reject) => {\n      try {\n        this.client = this.createClient();\n\n        if (!this.producerOnlyMode) {\n          const partitionAssigners = [\n            (\n              config: ConstructorParameters<\n                typeof KafkaReplyPartitionAssigner\n              >[1],\n            ) => new KafkaReplyPartitionAssigner(this, config),\n          ];\n\n          const consumerOptions = Object.assign(\n            {\n              partitionAssigners,\n            },\n            this.options.consumer || {},\n            {\n              groupId: this.groupId,\n            },\n          );\n\n          this.consumer = this.client.consumer(consumerOptions);\n          // set member assignments on join and rebalance\n          this.consumer.on(\n            this.consumer.events.GROUP_JOIN,\n            this.setConsumerAssignments.bind(this),\n          );\n          await this.consumer.connect();\n          await this.bindTopics();\n        }\n\n        this.producer = this.client.producer(this.options.producer || {});\n        await this.producer.connect();\n\n        resolve();\n      } catch (err) {\n        reject(err);\n      }\n    });\n    return this.initialized.then(() => this.producer);\n  }\n\n  public async bindTopics(): Promise<void> {\n    if (!this.consumer) {\n      throw Error('No consumer initialized');\n    }\n\n    const consumerSubscribeOptions = this.options.subscribe || {};\n    const subscribeTo = async (responsePattern: string) =>\n      this.consumer.subscribe({\n        topic: responsePattern,\n        ...consumerSubscribeOptions,\n      });\n    await Promise.all(this.responsePatterns.map(subscribeTo));\n\n    await this.consumer.run(\n      Object.assign(this.options.run || {}, {\n        eachMessage: this.createResponseCallback(),\n      }),\n    );\n  }\n\n  public createClient<T = any>(): T {\n    const kafkaConfig: KafkaConfig = Object.assign(\n      { logCreator: KafkaLogger.bind(null, this.logger) },\n      this.options.client,\n      { brokers: this.brokers, clientId: this.clientId },\n    );\n\n    return new kafkaPackage.Kafka(kafkaConfig);\n  }\n\n  public createResponseCallback(): (payload: EachMessagePayload) => any {\n    return async (payload: EachMessagePayload) => {\n      const rawMessage = this.parser.parse<KafkaMessage>(\n        Object.assign(payload.message, {\n          topic: payload.topic,\n          partition: payload.partition,\n        }),\n      );\n      if (isUndefined(rawMessage.headers[KafkaHeaders.CORRELATION_ID])) {\n        return;\n      }\n      const { err, response, isDisposed, id } =\n        await this.deserializer.deserialize(rawMessage);\n      const callback = this.routingMap.get(id);\n      if (!callback) {\n        return;\n      }\n      if (err || isDisposed) {\n        return callback({\n          err,\n          response,\n          isDisposed,\n        });\n      }\n      callback({\n        err,\n        response,\n      });\n    };\n  }\n\n  public getConsumerAssignments() {\n    return this.consumerAssignments;\n  }\n\n  protected async dispatchEvent(packet: OutgoingEvent): Promise<any> {\n    const pattern = this.normalizePattern(packet.pattern);\n    const outgoingEvent = await this.serializer.serialize(packet.data, {\n      pattern,\n    });\n    const message = Object.assign(\n      {\n        topic: pattern,\n        messages: [outgoingEvent],\n      },\n      this.options.send || {},\n    );\n\n    return this.producer.send(message);\n  }\n\n  protected getReplyTopicPartition(topic: string): string {\n    const minimumPartition = this.consumerAssignments[topic];\n    if (isUndefined(minimumPartition)) {\n      throw new InvalidKafkaClientTopicException(topic);\n    }\n\n    // get the minimum partition\n    return minimumPartition.toString();\n  }\n\n  protected publish(\n    partialPacket: ReadPacket,\n    callback: (packet: WritePacket) => any,\n  ): () => void {\n    const packet = this.assignPacketId(partialPacket);\n    this.routingMap.set(packet.id, callback);\n\n    const cleanup = () => this.routingMap.delete(packet.id);\n    const errorCallback = (err: unknown) => {\n      cleanup();\n      callback({ err });\n    };\n\n    try {\n      const pattern = this.normalizePattern(partialPacket.pattern);\n      const replyTopic = this.getResponsePatternName(pattern);\n      const replyPartition = this.getReplyTopicPartition(replyTopic);\n\n      Promise.resolve(this.serializer.serialize(packet.data, { pattern }))\n        .then((serializedPacket: KafkaRequest) => {\n          serializedPacket.headers[KafkaHeaders.CORRELATION_ID] = packet.id;\n          serializedPacket.headers[KafkaHeaders.REPLY_TOPIC] = replyTopic;\n          serializedPacket.headers[KafkaHeaders.REPLY_PARTITION] =\n            replyPartition;\n\n          const message = Object.assign(\n            {\n              topic: pattern,\n              messages: [serializedPacket],\n            },\n            this.options.send || {},\n          );\n\n          return this.producer.send(message);\n        })\n        .catch(err => errorCallback(err));\n\n      return cleanup;\n    } catch (err) {\n      errorCallback(err);\n    }\n  }\n\n  protected getResponsePatternName(pattern: string): string {\n    return `${pattern}.reply`;\n  }\n\n  protected setConsumerAssignments(data: ConsumerGroupJoinEvent): void {\n    const consumerAssignments: { [key: string]: number } = {};\n\n    // only need to set the minimum\n    Object.keys(data.payload.memberAssignment).forEach(memberId => {\n      const minimumPartition = Math.min(\n        ...data.payload.memberAssignment[memberId],\n      );\n\n      consumerAssignments[memberId] = minimumPartition;\n    });\n\n    this.consumerAssignments = consumerAssignments;\n  }\n\n  protected initializeSerializer(options: KafkaOptions['options']) {\n    this.serializer =\n      (options && options.serializer) || new KafkaRequestSerializer();\n  }\n\n  protected initializeDeserializer(options: KafkaOptions['options']) {\n    this.deserializer =\n      (options && options.deserializer) || new KafkaResponseDeserializer();\n  }\n\n  public commitOffsets(\n    topicPartitions: TopicPartitionOffsetAndMetadata[],\n  ): Promise<void> {\n    if (this.consumer) {\n      return this.consumer.commitOffsets(topicPartitions);\n    } else {\n      throw new Error('No consumer initialized');\n    }\n  }\n}\n"]}