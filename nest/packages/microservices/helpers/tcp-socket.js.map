{"version":3,"file":"tcp-socket.js","sourceRoot":"","sources":["tcp-socket.ts"],"names":[],"mappings":";;;AAEA,4CAMsB;AACtB,uFAAiF;AACjF,2FAAqF;AAErF,MAAsB,SAAS;IAG7B,IAAW,SAAS;QAClB,OAAO,IAAI,CAAC,MAAM,CAAC;IACrB,CAAC;IAED,YAA4B,MAAc;QAAd,WAAM,GAAN,MAAM,CAAQ;QANlC,aAAQ,GAAG,KAAK,CAAC;QAOvB,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,sBAAU,EAAE,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QACnD,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,yBAAa,EAAE,GAAG,EAAE,CAAC,CAAC,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC,CAAC,CAAC;QAC7D,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,uBAAW,EAAE,GAAG,EAAE,CAAC,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,CAAC,CAAC;QAC1D,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,uBAAW,EAAE,GAAG,EAAE,CAAC,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,CAAC,CAAC;IAC5D,CAAC;IAEM,OAAO,CAAC,IAAY,EAAE,IAAY;QACvC,IAAI,CAAC,MAAM,CAAC,OAAO,CAAC,IAAI,EAAE,IAAI,CAAC,CAAC;QAChC,OAAO,IAAI,CAAC;IACd,CAAC;IAEM,EAAE,CAAC,KAAa,EAAE,QAA6B;QACpD,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;QAChC,OAAO,IAAI,CAAC;IACd,CAAC;IAEM,IAAI,CAAC,KAAa,EAAE,QAA6B;QACtD,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,EAAE,QAAQ,CAAC,CAAC;QAClC,OAAO,IAAI,CAAC;IACd,CAAC;IAEM,GAAG;QACR,IAAI,CAAC,MAAM,CAAC,GAAG,EAAE,CAAC;QAClB,OAAO,IAAI,CAAC;IACd,CAAC;IAEM,WAAW,CAAC,OAAY,EAAE,QAA8B;QAC7D,IAAI,IAAI,CAAC,QAAQ,EAAE;YACjB,QAAQ,IAAI,QAAQ,CAAC,IAAI,sDAAwB,EAAE,CAAC,CAAC;YACrD,OAAO;SACR;QACD,IAAI,CAAC,UAAU,CAAC,OAAO,EAAE,QAAQ,CAAC,CAAC;IACrC,CAAC;IAIO,MAAM,CAAC,IAAY;QACzB,IAAI;YACF,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;SACvB;QAAC,OAAO,CAAC,EAAE;YACV,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,uBAAW,EAAE,CAAC,CAAC,OAAO,CAAC,CAAC;YACzC,IAAI,CAAC,MAAM,CAAC,GAAG,EAAE,CAAC;SACnB;IACH,CAAC;IAIS,WAAW,CAAC,IAAY;QAChC,IAAI,OAAgC,CAAC;QACrC,IAAI;YACF,OAAO,GAAG,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC;SAC5B;QAAC,OAAO,CAAC,EAAE;YACV,MAAM,IAAI,0DAA0B,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC;SAC/C;QACD,OAAO,GAAG,OAAO,IAAI,EAAE,CAAC;QACxB,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,yBAAa,EAAE,OAAO,CAAC,CAAC;IAC3C,CAAC;CACF;AAjED,8BAiEC","sourcesContent":["import { Buffer } from 'buffer';\nimport { Socket } from 'net';\nimport {\n  CLOSE_EVENT,\n  CONNECT_EVENT,\n  DATA_EVENT,\n  ERROR_EVENT,\n  MESSAGE_EVENT,\n} from '../constants';\nimport { NetSocketClosedException } from '../errors/net-socket-closed.exception';\nimport { InvalidJSONFormatException } from '../errors/invalid-json-format.exception';\n\nexport abstract class TcpSocket {\n  private isClosed = false;\n\n  public get netSocket() {\n    return this.socket;\n  }\n\n  constructor(public readonly socket: Socket) {\n    this.socket.on(DATA_EVENT, this.onData.bind(this));\n    this.socket.on(CONNECT_EVENT, () => (this.isClosed = false));\n    this.socket.on(CLOSE_EVENT, () => (this.isClosed = true));\n    this.socket.on(ERROR_EVENT, () => (this.isClosed = true));\n  }\n\n  public connect(port: number, host: string) {\n    this.socket.connect(port, host);\n    return this;\n  }\n\n  public on(event: string, callback: (err?: any) => void) {\n    this.socket.on(event, callback);\n    return this;\n  }\n\n  public once(event: string, callback: (err?: any) => void) {\n    this.socket.once(event, callback);\n    return this;\n  }\n\n  public end() {\n    this.socket.end();\n    return this;\n  }\n\n  public sendMessage(message: any, callback?: (err?: any) => void) {\n    if (this.isClosed) {\n      callback && callback(new NetSocketClosedException());\n      return;\n    }\n    this.handleSend(message, callback);\n  }\n\n  protected abstract handleSend(message: any, callback?: (err?: any) => void);\n\n  private onData(data: Buffer) {\n    try {\n      this.handleData(data);\n    } catch (e) {\n      this.socket.emit(ERROR_EVENT, e.message);\n      this.socket.end();\n    }\n  }\n\n  protected abstract handleData(data: Buffer | string);\n\n  protected emitMessage(data: string) {\n    let message: Record<string, unknown>;\n    try {\n      message = JSON.parse(data);\n    } catch (e) {\n      throw new InvalidJSONFormatException(e, data);\n    }\n    message = message || {};\n    this.socket.emit(MESSAGE_EVENT, message);\n  }\n}\n"]}