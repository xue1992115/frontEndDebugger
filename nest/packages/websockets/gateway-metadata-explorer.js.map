{"version":3,"file":"gateway-metadata-explorer.js","sourceRoot":"/Users/hanxiaoxue/Documents/work/frontEndDebugger/nest/packages/websockets/","sources":["gateway-metadata-explorer.ts"],"names":[],"mappings":";;;AAAA,oEAA4E;AAG5E,2CAIqB;AASrB,MAAa,uBAAuB;IAClC,YAA6B,eAAgC;QAAhC,oBAAe,GAAf,eAAe,CAAiB;IAAG,CAAC;IAE1D,OAAO,CAAC,QAAqB;QAClC,MAAM,iBAAiB,GAAG,MAAM,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC;QAC1D,OAAO,IAAI,CAAC,eAAe;aACxB,iBAAiB,CAAC,iBAAiB,CAAC;aACpC,GAAG,CAAC,MAAM,CAAC,EAAE,CAAC,IAAI,CAAC,qBAAqB,CAAC,iBAAiB,EAAE,MAAM,CAAC,CAAC;aACpE,MAAM,CAAC,QAAQ,CAAC,EAAE,CAAC,QAAQ,CAAC,CAAC;IAClC,CAAC;IAEM,qBAAqB,CAC1B,iBAAyB,EACzB,UAAkB;QAElB,MAAM,QAAQ,GAAG,iBAAiB,CAAC,UAAU,CAAC,CAAC;QAC/C,MAAM,gBAAgB,GAAG,OAAO,CAAC,WAAW,CAC1C,oCAAwB,EACxB,QAAQ,CACT,CAAC;QACF,IAAI,IAAA,0BAAW,EAAC,gBAAgB,CAAC,EAAE;YACjC,OAAO,IAAI,CAAC;SACb;QACD,MAAM,OAAO,GAAG,OAAO,CAAC,WAAW,CAAC,4BAAgB,EAAE,QAAQ,CAAC,CAAC;QAChE,OAAO;YACL,QAAQ;YACR,OAAO;YACP,UAAU;SACX,CAAC;IACJ,CAAC;IAEM,CAAC,kBAAkB,CAAC,QAAqB;QAC9C,KAAK,MAAM,WAAW,IAAI,QAAQ,EAAE;YAClC,IAAI,IAAA,yBAAU,EAAC,WAAW,CAAC,EAAE;gBAC3B,SAAS;aACV;YACD,MAAM,QAAQ,GAAG,MAAM,CAAC,WAAW,CAAC,CAAC;YACrC,MAAM,QAAQ,GAAG,OAAO,CAAC,WAAW,CAClC,mCAAuB,EACvB,QAAQ,EACR,QAAQ,CACT,CAAC;YACF,IAAI,CAAC,IAAA,0BAAW,EAAC,QAAQ,CAAC,EAAE;gBAC1B,MAAM,QAAQ,CAAC;aAChB;SACF;IACH,CAAC;CACF;AA/CD,0DA+CC","sourcesContent":["import { isFunction, isUndefined } from '@nestjs/common/utils/shared.utils';\nimport { MetadataScanner } from '@nestjs/core/metadata-scanner';\nimport { Observable } from 'rxjs';\nimport {\n  GATEWAY_SERVER_METADATA,\n  MESSAGE_MAPPING_METADATA,\n  MESSAGE_METADATA,\n} from './constants';\nimport { NestGateway } from './interfaces/nest-gateway.interface';\n\nexport interface MessageMappingProperties {\n  message: any;\n  methodName: string;\n  callback: (...args: any[]) => Observable<any> | Promise<any> | any;\n}\n\nexport class GatewayMetadataExplorer {\n  constructor(private readonly metadataScanner: MetadataScanner) {}\n\n  public explore(instance: NestGateway): MessageMappingProperties[] {\n    const instancePrototype = Object.getPrototypeOf(instance);\n    return this.metadataScanner\n      .getAllMethodNames(instancePrototype)\n      .map(method => this.exploreMethodMetadata(instancePrototype, method))\n      .filter(metadata => metadata);\n  }\n\n  public exploreMethodMetadata(\n    instancePrototype: object,\n    methodName: string,\n  ): MessageMappingProperties {\n    const callback = instancePrototype[methodName];\n    const isMessageMapping = Reflect.getMetadata(\n      MESSAGE_MAPPING_METADATA,\n      callback,\n    );\n    if (isUndefined(isMessageMapping)) {\n      return null;\n    }\n    const message = Reflect.getMetadata(MESSAGE_METADATA, callback);\n    return {\n      callback,\n      message,\n      methodName,\n    };\n  }\n\n  public *scanForServerHooks(instance: NestGateway): IterableIterator<string> {\n    for (const propertyKey in instance) {\n      if (isFunction(propertyKey)) {\n        continue;\n      }\n      const property = String(propertyKey);\n      const isServer = Reflect.getMetadata(\n        GATEWAY_SERVER_METADATA,\n        instance,\n        property,\n      );\n      if (!isUndefined(isServer)) {\n        yield property;\n      }\n    }\n  }\n}\n"]}